<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rental Inquiry - Texas Tough Rentals</title>
  <meta name="description" content="Submit a rental inquiry for Texas Tough Rentals trailers. Quick and easy online form.">
  <link rel="stylesheet" href="/src/css/style.css">
  
  <!-- Import Map for Zod -->
  <script type="importmap">
    {
      "imports": {
        "zod": "https://cdn.jsdelivr.net/npm/zod@3.22.4/+esm"
      }
    }
  </script>
</head>
<body>
  <header>
    <nav class="container">
      <div class="logo">
        <img src="images/logo.png" alt="Texas Tough Rentals logo" style="height:36px; vertical-align:middle; margin-right:8px;">
        Texas Tough Rentals
      </div>
      <ul class="nav-links">
        <li><a href="/">Home</a></li>
        <li><a href="/inquiry.html">Rent a Trailer</a></li>
        <li><a href="/#about">About</a></li>
        <li><a href="/#contact">Contact</a></li>
      </ul>
    </nav>
  </header>

  <main class="container">
    <section class="content-section">
      <h2>Trailer Rental Inquiry</h2>
      <p>Fill out the form below to inquire about renting a trailer. We'll get back to you as soon as possible!</p>
      
      <div class="form-container">
        <div class="form-success" id="successMessage" style="display:none;">
          <img src="images/logo.png" alt="success" style="height:28px; vertical-align:middle; margin-right:8px;">
          <strong>Success!</strong> Your inquiry has been submitted. We'll contact you shortly.
        </div>

        <form id="inquiryForm" novalidate>
          <div class="form-group">
            <label for="name">Name <span style="color: red;">*</span></label>
            <input type="text" id="name" name="name" required placeholder="John Doe">
            <div class="form-error" id="nameError"></div>
          </div>

          <div class="form-group">
            <label for="phone">Phone <span style="color: red;">*</span></label>
            <input type="tel" id="phone" name="phone" required placeholder="555-123-4567">
            <div class="form-error" id="phoneError"></div>
          </div>

          <div class="form-group">
            <label for="email">Email <span style="color: red;">*</span></label>
            <input type="email" id="email" name="email" required placeholder="you@example.com">
            <div class="form-error" id="emailError"></div>
          </div>

          <div class="form-group">
            <label for="company">Company</label>
            <input type="text" id="company" name="company" placeholder="Optional">
            <div class="form-error" id="companyError"></div>
          </div>

          <div class="form-group">
            <label for="pickupLocation">Pickup Location <span style="color: red;">*</span></label>
            <input type="text" id="pickupLocation" name="pickupLocation" required placeholder="City, address, or ZIP">
            <div class="form-error" id="pickupLocationError"></div>
          </div>

          <div class="form-group">
            <label for="pickupDate">Pickup Date & Time <span style="color: red;">*</span></label>
            <input type="datetime-local" id="pickupDate" name="pickupDate" required>
            <div class="form-error" id="pickupDateError"></div>
          </div>

          <div class="form-group">
            <label for="deliveryLocation">Delivery Location <span style="color: red;">*</span></label>
            <input type="text" id="deliveryLocation" name="deliveryLocation" required placeholder="City, address, or ZIP">
            <div class="form-error" id="deliveryLocationError"></div>
          </div>

          <div class="form-group">
            <label for="deliveryDate">Delivery Date & Time <span style="color: red;">*</span></label>
            <input type="datetime-local" id="deliveryDate" name="deliveryDate" required>
            <div class="form-error" id="deliveryDateError"></div>
          </div>

          <div class="form-group">
            <label for="dimensions">Load Dimensions</label>
            <input type="text" id="dimensions" name="dimensions" placeholder="e.g. 8ft x 6ft x 4ft">
            <div class="form-error" id="dimensionsError"></div>
          </div>

          <div class="form-group">
            <label for="weight">Estimated Weight (lbs)</label>
            <input type="number" id="weight" name="weight" min="0" placeholder="e.g. 1200">
            <div class="form-error" id="weightError"></div>
          </div>

          <div class="form-group">
            <label for="additionalInfo">Additional Info</label>
            <textarea id="additionalInfo" name="additionalInfo" rows="4" placeholder="Any special instructions or notes"></textarea>
            <div class="form-error" id="additionalInfoError"></div>
          </div>

          <button type="submit" class="btn btn-primary" style="width: 100%;">Submit Inquiry</button>
        </form>
      </div>
    </section>
  </main>

  <footer>
    <div class="container">
      <div class="footer-content">
        <ul class="footer-links">
          <li><a href="/">Home</a></li>
          <li><a href="/inquiry.html">Rent a Trailer</a></li>
          <li><a href="/#about">About</a></li>
          <li><a href="/#contact">Contact</a></li>
        </ul>
        <p>&copy; 2025 Texas Tough Rentals. All rights reserved.</p>
      </div>
    </div>
  </footer>

  <!-- Form validation script using Zod -->
  <script type="module">
    import { inquirySchema, validateFormData } from '/src/js/schemas.js';

    const form = document.getElementById('inquiryForm');
    const successMessage = document.getElementById('successMessage');

    // Set minimum datetime to now (rounded to minutes) for pickup and delivery
    function toLocalDateTimeInputValue(d) {
      const pad = (n) => String(n).padStart(2, '0');
      return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }

    const now = new Date();
    now.setSeconds(0, 0);
    const minDateTime = toLocalDateTimeInputValue(now);

    const pickupDateInput = document.getElementById('pickupDate');
    const deliveryDateInput = document.getElementById('deliveryDate');
    pickupDateInput.min = minDateTime;
    deliveryDateInput.min = minDateTime;

    // Prevent selecting past dates and ensure delivery >= pickup
    function isDateTimeLocalFormat(v) {
      return /^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}$/.test(v);
    }

    function showDateError(fieldName, msg) {
      const errEl = document.getElementById(`${fieldName}Error`);
      const input = document.getElementById(fieldName);
      if (errEl) {
        errEl.textContent = msg;
        errEl.classList.add('show');
      }
      if (input) {
        input.closest('.form-group')?.classList.add('error');
      }
    }

    function clearDateError(fieldName) {
      const errEl = document.getElementById(`${fieldName}Error`);
      const input = document.getElementById(fieldName);
      if (errEl) {
        errEl.textContent = '';
        errEl.classList.remove('show');
      }
      if (input) {
        input.closest('.form-group')?.classList.remove('error');
      }
    }

    // When pickup changes, update delivery min and validate
    pickupDateInput.addEventListener('change', () => {
      clearDateError('pickupDate');
      if (!pickupDateInput.value || !isDateTimeLocalFormat(pickupDateInput.value)) {
        showDateError('pickupDate', 'Please choose a valid pickup date and time');
        return;
      }

      // Enforce pickup not in the past
      if (pickupDateInput.value < minDateTime) {
        showDateError('pickupDate', 'Pickup date/time cannot be in the past');
        // reset to min allowed
        pickupDateInput.value = minDateTime;
      } else {
        clearDateError('pickupDate');
      }

      // Ensure delivery cannot be before pickup
      deliveryDateInput.min = pickupDateInput.value;
      if (deliveryDateInput.value && deliveryDateInput.value < pickupDateInput.value) {
        deliveryDateInput.value = pickupDateInput.value;
        clearDateError('deliveryDate');
      }
    });

    // When delivery changes, validate against pickup
    deliveryDateInput.addEventListener('change', () => {
      clearDateError('deliveryDate');
      if (!deliveryDateInput.value || !isDateTimeLocalFormat(deliveryDateInput.value)) {
        showDateError('deliveryDate', 'Please choose a valid delivery date and time');
        return;
      }

      if (deliveryDateInput.value < (pickupDateInput.value || minDateTime)) {
        showDateError('deliveryDate', 'Delivery date/time must be after pickup date/time');
        // Snap to pickup if possible
        if (pickupDateInput.value) deliveryDateInput.value = pickupDateInput.value;
      } else {
        clearDateError('deliveryDate');
      }
    });

    // Clear error on input
    form.querySelectorAll('input, select, textarea').forEach(field => {
      field.addEventListener('input', () => {
        const errorElement = document.getElementById(`${field.name}Error`);
        if (errorElement) {
          errorElement.textContent = '';
          errorElement.classList.remove('show');
          field.closest('.form-group').classList.remove('error');
        }
      });
    });

    // Form submission handler
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      // Clear previous errors
      form.querySelectorAll('.form-error').forEach(error => {
        error.textContent = '';
        error.classList.remove('show');
      });
      form.querySelectorAll('.form-group').forEach(group => {
        group.classList.remove('error');
      });
      if (successMessage) successMessage.classList.remove('show');

      // Collect form data
      const formData = new FormData(form);
      const data = {
        name: formData.get('name'),
        phone: formData.get('phone'),
        email: formData.get('email'),
        company: formData.get('company') || undefined,
        pickupLocation: formData.get('pickupLocation'),
        pickupDate: formData.get('pickupDate'),
        deliveryLocation: formData.get('deliveryLocation'),
        deliveryDate: formData.get('deliveryDate'),
        dimensions: formData.get('dimensions') || undefined,
        weight: formData.get('weight') || undefined,
        additionalInfo: formData.get('additionalInfo') || undefined
      };

      // Validate using Zod (client-side)
      const result = validateFormData(inquirySchema, data);

      if (result.success) {
        // Success! Show temporary success locally, then attempt server submission
        console.log('Form validated successfully (client):', result.data);

        // Send sanitized data to server endpoint
        try {
          const resp = await fetch('/api/submit-quote', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(result.data)
          });

          const payload = await resp.json();

          if (resp.ok && payload.success) {
            if (successMessage) {
              successMessage.style.display = 'block';
              successMessage.classList.add('show');
            }
            form.reset();
            successMessage?.scrollIntoView({ behavior: 'smooth', block: 'center' });
          } else {
            // Server-side validation errors expected in payload.errors as field->message
            if (payload && payload.errors) {
              Object.keys(payload.errors).forEach(fieldName => {
                const errorElement = document.getElementById(`${fieldName}Error`);
                const formGroup = document.getElementById(fieldName)?.closest('.form-group');
                if (errorElement) {
                  errorElement.textContent = payload.errors[fieldName];
                  errorElement.classList.add('show');
                  formGroup?.classList.add('error');
                }
              });
            } else {
              alert('Submission failed. Please try again later.');
            }
          }
        } catch (err) {
          console.error('Network/server error:', err);
          alert('Network error. Please try again later.');
        }

      } else {
        // Show validation errors
        console.error('Validation errors:', result.errors);
        
        Object.keys(result.errors).forEach(fieldName => {
          const errorElement = document.getElementById(`${fieldName}Error`);
          const formGroup = document.getElementById(fieldName)?.closest('.form-group');
          
          if (errorElement) {
            errorElement.textContent = result.errors[fieldName];
            errorElement.classList.add('show');
            formGroup?.classList.add('error');
          }
        });

        // Scroll to first error
        const firstError = form.querySelector('.form-group.error');
        if (firstError) {
          firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
      }
    });
  </script>
</body>
</html>
