<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rental Inquiry - Texas Tough Rentals</title>
  <meta name="description" content="Submit a rental inquiry for Texas Tough Rentals trailers. Quick and easy online form.">
  <link rel="stylesheet" href="/src/css/style.css">
  
  <!-- Import Map for Zod -->
  <script type="importmap">
    {
      "imports": {
        "zod": "https://cdn.jsdelivr.net/npm/zod@3.22.4/+esm"
      }
    }
  </script>
</head>
<body>
  <header>
    <nav class="container">
      <div class="logo">
        <img src="images/logo.png" alt="Texas Tough Rentals logo" style="height:36px; vertical-align:middle; margin-right:8px;">
        Texas Tough Rentals
      </div>
      <ul class="nav-links">
        <li><a href="/">Home</a></li>
        <li><a href="/inquiry.html">Rent a Trailer</a></li>
        <li><a href="/#about">About</a></li>
        <li><a href="/#contact">Contact</a></li>
      </ul>
    </nav>
  </header>

  <main class="container">
    <section class="content-section">
      <h2>Trailer Rental Inquiry</h2>
      <p>Fill out the form below to inquire about renting a trailer. We'll get back to you as soon as possible!</p>
      
      <div class="form-container">
        <div class="form-success" id="successMessage">
          <img src="images/logo.png" alt="success" style="height:28px; vertical-align:middle; margin-right:8px;">
          <strong>Success!</strong> Your inquiry has been submitted. We'll contact you shortly.
        </div>

        <form id="inquiryForm" novalidate>
          <div class="form-group">
            <label for="name">Name <span style="color: red;">*</span></label>
            <input type="text" id="name" name="name" required placeholder="John Doe">
            <div class="form-error" id="nameError"></div>
          </div>

          <div class="form-group">
            <label for="phone">Phone <span style="color: red;">*</span></label>
            <input type="tel" id="phone" name="phone" required placeholder="555-123-4567">
            <div class="form-error" id="phoneError"></div>
          </div>

          <div class="form-group">
            <label for="email">Email <span style="color: red;">*</span></label>
            <input type="email" id="email" name="email" required placeholder="john@example.com">
            <div class="form-error" id="emailError"></div>
          </div>

          <div class="form-group">
            <label for="company">Company</label>
            <input type="text" id="company" name="company" placeholder="Company name (optional)">
            <div class="form-error" id="companyError"></div>
          </div>

          <div class="form-group">
            <label for="pickupLocation">Pickup Location <span style="color: red;">*</span></label>
            <input type="text" id="pickupLocation" name="pickupLocation" required placeholder="Keller, TX 76244, United States">
            <div class="form-error" id="pickupLocationError"></div>
          </div>

          <div class="form-group">
            <label for="pickupDate">Pickup Date/Time <span style="color: red;">*</span></label>
            <input type="datetime-local" id="pickupDate" name="pickupDate" required>
            <div class="form-error" id="pickupDateError"></div>
          </div>

          <div class="form-group">
            <label for="deliveryLocation">Delivery Location <span style="color: red;">*</span></label>
            <input type="text" id="deliveryLocation" name="deliveryLocation" required placeholder="Keller, TX 76244, United States">
            <div class="form-error" id="deliveryLocationError"></div>
          </div>

          <div class="form-group">
            <label for="deliveryDate">Delivery Date/Time <span style="color: red;">*</span></label>
            <input type="datetime-local" id="deliveryDate" name="deliveryDate" required>
            <div class="form-error" id="deliveryDateError"></div>
          </div>

          <div class="form-group">
            <label for="dimensions">Dimensions</label>
            <input type="text" id="dimensions" name="dimensions" placeholder="e.g. 8ft x 6ft x 4ft">
            <div class="form-error" id="dimensionsError"></div>
          </div>

          <div class="form-group">
            <label for="weight">Total Weight (lbs)</label>
            <input type="number" id="weight" name="weight" min="0" step="any" placeholder="e.g. 1500">
            <div class="form-error" id="weightError"></div>
          </div>

          <div class="form-group">
            <label for="additionalInfo">Additional Information</label>
            <textarea id="additionalInfo" name="additionalInfo" placeholder="Any special instructions or notes..."></textarea>
            <div class="form-error" id="additionalInfoError"></div>
          </div>

          <button type="submit" class="btn btn-primary" style="width: 100%;">Submit Inquiry</button>
        </form>
      </div>
    </section>
  </main>

  <footer>
    <div class="container">
      <div class="footer-content">
        <ul class="footer-links">
          <li><a href="/">Home</a></li>
          <li><a href="/inquiry.html">Rent a Trailer</a></li>
          <li><a href="/#about">About</a></li>
          <li><a href="/#contact">Contact</a></li>
        </ul>
        <p>&copy; 2025 Texas Tough Rentals. All rights reserved.</p>
      </div>
    </div>
  </footer>

  <!-- Form validation script using Zod -->
  <script type="module">
    import { inquirySchema, validateFormData } from '/src/js/schemas.js';

    const form = document.getElementById('inquiryForm');
    const successMessage = document.getElementById('successMessage');

    // Set minimum datetime to now (rounded to minutes) for pickup and delivery
    function toLocalDateTimeInputValue(d) {
      const pad = (n) => String(n).padStart(2, '0');
      return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }

    const now = new Date();
    now.setSeconds(0, 0);
    const minDateTime = toLocalDateTimeInputValue(now);

    const pickupDateInput = document.getElementById('pickupDate');
    const deliveryDateInput = document.getElementById('deliveryDate');
    pickupDateInput.min = minDateTime;
    deliveryDateInput.min = minDateTime;

    // Clear error on input
    form.querySelectorAll('input, select, textarea').forEach(field => {
      field.addEventListener('input', () => {
        const errorElement = document.getElementById(`${field.name}Error`);
        if (errorElement) {
          errorElement.textContent = '';
          errorElement.classList.remove('show');
          field.closest('.form-group').classList.remove('error');
        }
      });
    });

    // Form submission handler
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      // Clear previous errors
      form.querySelectorAll('.form-error').forEach(error => {
        error.textContent = '';
        error.classList.remove('show');
      });
      form.querySelectorAll('.form-group').forEach(group => {
        group.classList.remove('error');
      });
      successMessage.classList.remove('show');

      // Collect form data
      const formData = new FormData(form);
      const data = {
        name: formData.get('name'),
        phone: formData.get('phone'),
        email: formData.get('email'),
        company: formData.get('company') || undefined,
        pickupLocation: formData.get('pickupLocation'),
        pickupDate: formData.get('pickupDate'),
        deliveryLocation: formData.get('deliveryLocation'),
        deliveryDate: formData.get('deliveryDate'),
        dimensions: formData.get('dimensions') || undefined,
        weight: formData.get('weight') || undefined,
        additionalInfo: formData.get('additionalInfo') || undefined
      };

      // Validate using Zod (client-side)
      const result = validateFormData(inquirySchema, data);

      if (result.success) {
        // Success! Show temporary success locally, then attempt server submission
        console.log('Form validated successfully (client):', result.data);

        // Send sanitized data to server endpoint
        try {
          const resp = await fetch('/api/submit-quote', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(result.data)
          });

          const payload = await resp.json();

          if (resp.ok && payload.success) {
            successMessage.classList.add('show');
            form.reset();
            successMessage.scrollIntoView({ behavior: 'smooth', block: 'center' });
          } else {
            // Server-side validation errors expected in payload.errors as field->message
            if (payload && payload.errors) {
              Object.keys(payload.errors).forEach(fieldName => {
                const errorElement = document.getElementById(`${fieldName}Error`);
                const formGroup = document.getElementById(fieldName)?.closest('.form-group');
                if (errorElement) {
                  errorElement.textContent = payload.errors[fieldName];
                  errorElement.classList.add('show');
                  formGroup?.classList.add('error');
                }
              });
            } else {
              alert('Submission failed. Please try again later.');
            }
          }
        } catch (err) {
          console.error('Network/server error:', err);
          alert('Network error. Please try again later.');
        }

      } else {
        // Show validation errors
        console.error('Validation errors:', result.errors);
        
        Object.keys(result.errors).forEach(fieldName => {
          const errorElement = document.getElementById(`${fieldName}Error`);
          const formGroup = document.getElementById(fieldName)?.closest('.form-group');
          
          if (errorElement) {
            errorElement.textContent = result.errors[fieldName];
            errorElement.classList.add('show');
            formGroup?.classList.add('error');
          }
        });

        // Scroll to first error
        const firstError = form.querySelector('.form-group.error');
        if (firstError) {
          firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
      }
    });
  </script>
</body>
</html>
